import{r as n,R}from"./index-Cc1jbXyT.js";import{Scene as se,PerspectiveCamera as ie,WebGLRenderer as ue,HemisphereLight as le,DirectionalLight as me,PlaneGeometry as de,ShadowMaterial as pe,Mesh as he,Group as fe,Box3 as ye,Vector3 as X,AnimationMixer as we,LoopRepeat as be,Clock as ge}from"./three.module-BX2Vlr8r.js";import{GLTFLoader as Se}from"./GLTFLoader-nBVbhmug.js";const Z={Romance:{className:"bg-romance",motion:{bobAmp:.02,bobSpeed:1,swayAmp:.02,swaySpeed:.5}},Adventure:{className:"bg-adventure",motion:{bobAmp:.03,bobSpeed:1.2,swayAmp:.03,swaySpeed:.7}},Mystery:{className:"bg-mystery",motion:{bobAmp:.015,bobSpeed:.8,swayAmp:.015,swaySpeed:.3}},Comedy:{className:"bg-comedy",motion:{bobAmp:.025,bobSpeed:1.3,swayAmp:.03,swaySpeed:.9}},Drama:{className:"bg-drama",motion:{bobAmp:.02,bobSpeed:.9,swayAmp:.02,swaySpeed:.5}},"Sci-Fi":{className:"bg-scifi",motion:{bobAmp:.02,bobSpeed:1.1,swayAmp:.025,swaySpeed:.7}}};function Re(p,A=12){if(!p)return[];const h=p.replace(/\n+/g," ").split(new RegExp("(?<=[\\.!?])\\s+")).filter(Boolean),f=Math.max(1,h.length),v=A/f;return h.map((y,M)=>({t:M*v,text:y}))}function Ce({avatarUrl:p,genres:A=[],audioUrl:h="",subtitles:f=null,fallbackSubtitleFromPlot:v="",onEnded:y}){const M=n.useRef(null),T=n.useRef(null),L=n.useRef(null),U=n.useRef(null),q=n.useRef(0),G=n.useRef(null),x=n.useRef(null),C=n.useRef(null),z=n.useRef(null),k=n.useRef({mesh:null,dict:null,indices:[]}),[Ae,ee]=n.useState(!1),[O,H]=n.useState(""),[V,te]=n.useState(""),[Y,ne]=n.useState(0),oe=A&&A.length?A[0]:"Drama",_=Z[oe]||Z.Drama,re=_.className,u=_.motion,w=n.useMemo(()=>f&&f.length?f:Re(v||"",Math.max(8,Math.min(24,Math.floor(Y||12)))),[f,v,Y]);return n.useEffect(()=>{const e=M.current;if(!e)return;const o=new se;o.background=null;const c=new ie(35,e.clientWidth/e.clientHeight,.1,100);c.position.set(0,1.6,2.2);const t=new ue({antialias:!0,alpha:!0});t.setPixelRatio(window.devicePixelRatio||1),t.setSize(e.clientWidth,e.clientHeight),e.appendChild(t.domElement);const b=new le(16777215,2236996,.8);o.add(b);const l=new me(16777215,.8);l.position.set(2,3,2),o.add(l);const I=new de(10,10),j=new pe({opacity:.15}),B=new he(I,j);B.rotation.x=-Math.PI/2,B.position.y=0,B.receiveShadow=!0;const g=new fe;U.current=g,o.add(g);const ae=new Se;let $=!1;p&&ae.load(p,s=>{var E;if($)return;const a=s.scene||((E=s.scenes)==null?void 0:E[0]);if(a){a.traverse(r=>{r.isMesh&&(r.castShadow=!0,r.receiveShadow=!1)});const m=new ye().setFromObject(a),d=new X;m.getSize(d);const N=new X;m.getCenter(N),a.position.sub(N);const P=d.y>0?1.7/d.y:1;if(a.scale.setScalar(P),g.add(a),L.current=a,s.animations&&s.animations.length){const r=new we(a);T.current=r;const S=s.animations[0],W=r.clipAction(S);W.loop=be,W.play()}let i=null,D=null;if(a.traverse(r=>{r.isMesh&&r.morphTargetDictionary&&Object.keys(r.morphTargetDictionary).find(ce=>/mouth|jaw|vowel|aa|oh|ee|open/i.test(ce))&&(i=r,D=r.morphTargetDictionary)}),i&&D){const r=Object.entries(D).filter(([S])=>/mouth|jaw|vowel|aa|oh|ee|open/i.test(S)).map(([,S])=>S);k.current={mesh:i,dict:D,indices:r}}}},void 0,s=>{console.warn("GLB load error",s)});function J(){e&&(c.aspect=e.clientWidth/e.clientHeight,c.updateProjectionMatrix(),t.setSize(e.clientWidth,e.clientHeight))}window.addEventListener("resize",J);const K=new ge;function Q(){q.current=requestAnimationFrame(Q);const s=K.getDelta(),a=K.elapsedTime;if(T.current)try{T.current.update(s)}catch{}if(g&&(g.position.y=Math.sin(a*u.bobSpeed)*u.bobAmp,g.rotation.y=Math.sin(a*u.swaySpeed)*u.swayAmp),C.current&&k.current.mesh)try{const E=C.current,m=z.current;E.getByteFrequencyData(m);let d=0;for(let i=0;i<m.length;i++)d+=m[i];d/=m.length||1;const N=Math.min(1,Math.max(0,(d-30)/120)),{mesh:F,indices:P}=k.current;P.forEach(i=>{F.morphTargetInfluences&&(F.morphTargetInfluences[i]=N*.7)})}catch{}else if(L.current)try{L.current.rotation.y=Math.sin(a*.2)*.1}catch{}t.render(o,c)}return Q(),()=>{$=!0,cancelAnimationFrame(q.current),window.removeEventListener("resize",J);try{e.removeChild(t.domElement)}catch{}t.dispose()}},[p,u.bobAmp,u.bobSpeed,u.swayAmp,u.swaySpeed]),n.useEffect(()=>{if(!h)return;const e=new Audio(h);G.current=e,e.preload="auto",e.autoplay=!0,e.oncanplay=()=>{ee(!0),ne(e.duration||0),e.play().catch(()=>{H("Tap to play")});try{const t=new(window.AudioContext||window.webkitAudioContext);x.current=t;const b=t.createMediaElementSource(e),l=t.createAnalyser();l.fftSize=64;const I=l.frequencyBinCount,j=new Uint8Array(I);b.connect(l),l.connect(t.destination),C.current=l,z.current=j}catch{}},e.onerror=()=>H("Audio failed to load"),e.onended=()=>{try{y==null||y()}catch{}};let o=0;const c=setInterval(()=>{if(!e||!w||w.length===0)return;const t=e.currentTime||0;for(;o+1<w.length&&t>=w[o+1].t;)o+=1;const b=w[o];b&&te(b.text)},100);return()=>{var t;clearInterval(c);try{e.pause()}catch{}G.current=null;try{(t=x.current)==null||t.close()}catch{}x.current=null,C.current=null,z.current=null}},[h,w,y]),R.createElement("div",{className:`cinematic-root ${re}`},R.createElement("div",{className:"cinematic-stage"},R.createElement("div",{className:"three-mount",ref:M}),O&&R.createElement("button",{className:"audio-unmute",onClick:()=>{var e,o,c;try{(e=G.current)==null||e.play(),H(""),(c=(o=x.current)==null?void 0:o.resume)==null||c.call(o)}catch{}}},O),V&&R.createElement("div",{className:"subtitles"},R.createElement("div",{className:"subtitle-line"},V))))}export{Ce as default};
